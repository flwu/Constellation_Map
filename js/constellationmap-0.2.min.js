var globalWrapper=function(e,t,n){"use strict";function s(e,t){var n,s;return n=Math.pow(10,t),s=Math.round(e*n)/n}var l,a,r,c,o,i,d,u,g,p=690,f=690,h=n.scale.linear(),x=n.scale.linear();return r=function(){var e={};return e.intersect=function(e,t){for(var n=0,s=0,l=[];n<e.length&&s<t.length;)e[n]<t[s]?n+=1:e[n]>t[s]?s+=1:(l.push(e[n]),n+=1,s+=1);return l},e.intersectMult=function(t){var n,s=t[0].sort();for(n=1;n<t.length;n+=1)s=e.intersect(s,t[n].sort());return s},e.union=function(e,t){for(var n=0,s=0,l=[];n<e.length&&s<t.length;)e[n]<t[s]?(l.push(e[n]),n+=1):e[n]>t[s]?(l.push(t[s]),s+=1):(l.push(e[n]),n+=1,s+=1);return n===e.length&&s<t.length?l=l.concat(t.slice(s,t.length)):s===t.length&&n<e.length&&(l=l.concat(e.slice(n,e.length))),l},e.unionMult=function(t){var n,s=t[0].sort();for(n=1;n<t.length;n+=1)s=e.union(s,t[n].sort());return s},e.intersectFuzzy=function(t,n){var s,l,a,r,c=t.length,o=[];if(!(2>n||n>c||1===c)){if(2===c||c===n)o=e.intersectMult(t);else for(a=e.unionMult(t),s=0;s<a.length;s+=1){for(r=0,l=0;n>r&&c>l;)r+=t[l].indexOf(a[s])>-1,l+=1;r===n&&o.push(a[s])}return o}},e.unique=function(e,t){var n=e.filter(function(e){return-1===t.indexOf(e)});return n},e}(e,jQuery),c=function(e,t){function a(e){"undefined"==typeof e?(n.select("#tableOne").select("tbody").selectAll("tr").remove(),n.select("#tableTwo").select("tbody").selectAll("tr").remove()):1===e?n.select("#tableOne").select("tbody").selectAll("tr").remove():2===e&&n.select("#tableTwo").select("tbody").selectAll("tr").remove()}function c(t){var s,l="";if(0===t.length)n.select("#exportGenelist").attr("href","#"),n.select("#exportGenelist").select("button").classed("disabled",!0);else{for(n.select("#exportGenelist").select("button").classed("disabled",!1),s=0;s<t.length;s+=1)l=l+t[s]+"\n";n.select("#exportGenelist").attr("href","data:application/octet-stream;charset=utf-8;base64,"+e.btoa(l)).attr("download","genelist.txt")}}var o={};return o.display=function(){var e,o,d,u,g,p,f,h,x=l.selectAll(".selectedNode").data(),v=(l.selectAll(".selectedEdge").data(),[]);if(0!==x.length){for(a(),n.select("#liveTextOneA").select("b").text(x.length),d=n.select("#tableOne"),e=0;e<x.length;e+=1)p=x[e],v[e]=p.MemberGenes,g=d.select("tbody").append("tr"),g.append("td").append("a").attr("href",p.url).attr("target","_blank").text(p["Gene.Set.Name"]),g.append("td").text(p["gene.set.size"]),g.append("td").text("("+s(p.x,3)+","+s(p.y,3)+")");if(1===v.length?(h=v[0].sort(),f=v[0].sort()):(h=r.intersectMult(v),f=r.unionMult(v)),2===x.length?(o=h.length/f.length,n.select("#liveTextOneB").select("b").text(s(o,3)),n.select("#liveTextOneB").classed("grayedText",!1)):(n.select("#liveTextOneB").select("b").text("NA"),n.select("#liveTextOneB").classed("grayedText",!0)),n.select("#liveTextTwoA").select("b").text(f.length),n.select("#liveTextTwoB").select("b").text(h.length),t("#fuzzFactor").val(x.length),n.select("#fuzzWarning").classed("hidden",!0),c(h),u=n.select("#tableTwo"),0===h.length)u.select("tbody").append("tr").append("td").text("No overlapping genes found");else for(e=0;e<h.length;e+=1)u.select("tbody").append("tr").append("td").text(h[e]);i.activate(h)}},o.fuzzFactorListen=function(){t(document).on("change","#fuzzFactor",function(){var e,t,s,o,d=l.selectAll(".selectedNode").data(),u=parseInt(document.getElementById("fuzzFactor").value,10),g=[];if(1>u)n.select("#fuzzWarning").classed("hidden",!1),n.select("#fuzzWarningText").text("Warning! Cannot overlap fewer than 1 gene set.");else if(u>d.length)n.select("#fuzzWarning").classed("hidden",!1),n.select("#fuzzWarningText").text("Warning! Cannot overlap more gene sets than number selected ("+d.length+").");else{for(n.select("#fuzzWarning").classed("hidden",!0),e=0;e<d.length;e+=1)g[e]=d[e].MemberGenes;for(1===d.length?(t=g[0].sort(),s=t):t=r.unionMult(g),s=1===u?t:r.intersectFuzzy(g,u),a(2),n.select("#liveTextTwoA").select("b").text(t.length),n.select("#liveTextTwoB").select("b").text(s.length),c(s),o=n.select("#tableTwo"),e=0;e<s.length;e+=1)o.select("tbody").append("tr").append("td").text(s[e]);i.activate(s)}})},o}(e,jQuery),o=function(){function e(e,t,n){var s={};return s.x=Math.cos(e)*n.x-Math.sin(e)*n.y+t.x,s.y=Math.sin(e)*n.x+Math.cos(e)*n.y+t.y,s}var t={};return t.interpolateCross=function(e){var t,n=h(0)+e/3,s=h(0)+e,l=h(0)-e/3,a=h(0)-e,r=f-(x(0)+e/3),c=f-(x(0)+e),o=f-(x(0)-e/3),i=f-(x(0)-e),d=[],u=[],g="";for(d[0]=n,d[1]=n,d[2]=s,d[3]=s,d[4]=n,d[5]=n,d[6]=l,d[7]=l,d[8]=a,d[9]=a,d[10]=l,d[11]=l,u[0]=c,u[1]=r,u[2]=r,u[3]=o,u[4]=o,u[5]=i,u[6]=i,u[7]=o,u[8]=o,u[9]=r,u[10]=r,u[11]=c,t=0;t<d.length;t+=1)g=g+d[t]+","+u[t]+" ";return g},t.jaccard2Width=function(e,t,n){var s;return s=t===n?2:5*(e-n)/(t-n)+1},t.calcEdgePath=function(t,n,s,l,a){var r,c=Math.atan((t.y-n.y)/(t.x-n.x)),o={x:(t.x+n.x)/2,y:(t.y+n.y)/2},i=Math.sqrt(Math.pow(o.x-t.x,2)+Math.pow(o.y-t.y,2)),d={x:i-s*Math.cos(l),y:s*Math.sin(l)},u=[{},{},{},{}],g={x:i-s/Math.cos(l)+a*Math.tan(l),y:a},p=[{},{},{},{}];return u[0]=e(c,o,{x:-d.x,y:d.y}),u[1]=e(c,o,{x:d.x,y:d.y}),u[2]=e(c,o,{x:d.x,y:-d.y}),u[3]=e(c,o,{x:-d.x,y:-d.y}),p[0]=e(c,o,{x:-g.x,y:g.y}),p[1]=e(c,o,{x:g.x,y:g.y}),p[2]=e(c,o,{x:g.x,y:-g.y}),p[3]=e(c,o,{x:-g.x,y:-g.y}),r="M"+u[0].x+" "+u[0].y+"C"+p[0].x+" "+p[0].y+" "+p[1].x+" "+p[1].y+" "+u[1].x+" "+u[1].y+"L"+u[2].x+" "+u[2].y+"C"+p[2].x+" "+p[2].y+" "+p[3].x+" "+p[3].y+" "+u[3].x+" "+u[3].y+"Z"},t.setScales=function(e){var t=100;h.domain([-e,e]),h.range([t,p-t]),x.domain([-e,e]),x.range([t,f-t])},t}(e,jQuery),i=function(e){function t(t){var n,s;for(s="http://www.broadinstitute.org/gsea/msigdb/annotate.jsp?geneList=",n=0;n<t.length;n+=1)s+=t[n],s+=",";e.open(s)}function s(t){var n,s;for(s="http://david.abcc.ncifcrf.gov/api.jsp?type=OFFICIAL_GENE_SYMBOL&ids=",n=0;n<t.length;n+=1)s+=t[n],s+=",";s+="&tool=summary",e.open(s)}function l(t){var n,s;for(s="http://genemania.org/link?o=9606&g=",n=0;n<t.length;n+=1)s+=t[n],s+="|";e.open(s)}var a={};return a.activate=function(e){0===e.length?(n.select(".msigdbAnnotation").classed("disabled",!0),n.select(".davidAnnotation").classed("disabled",!0),n.select(".genemaniaAnnotation").classed("disabled",!0)):(n.select(".msigdbAnnotation").classed("disabled",!1).on("click",function(){t(e)}),n.select(".davidAnnotation").classed("disabled",!1).on("click",function(){s(e)}),n.select(".genemaniaAnnotation").classed("disabled",!1).on("click",function(){l(e)}))},a}(e,jQuery),d=function(){function e(){l.selectAll("circle").classed("selectedNode",!1),l.selectAll("circle").classed("geneset",function(e){return 0===e.x&&0===e.y?!1:!0}),l.select("#edgeGroup").selectAll("path").classed("selectedEdge",!1)}var t={};return t.move=function(){e();var t=a.extent(),n=l.selectAll(".geneset");n.classed("selectedNode",function(e){return t[0][0]<h(e.x)&&h(e.x)<t[1][0]&&t[0][1]<f-x(e.y)&&f-x(e.y)<t[1][1]})},t.stop=function(){c.display()},t}(e,jQuery),u=function(e,t){function s(e){var t,n,s,l,a,r,c,o,i,d,u,g,p=parseInt(e[1].split("=")[1],10),f={};for(t=2;2+p>t;t+=1)n=e[t].split("="),s=e[t].split(":"),2===n.length&&(f[n[0]]=n[1]),2===s.length&&(l=s[1].split("	"),f[s[0]]=l);for(a=parseInt(f.DataLines,10),r=[],c=0;a>c;c+=1)for(o=e[c+2+p].split("	"),r[c]={},i=0;i<o.length;i+=1)d=f.COLUMN_NAMES[i],u=f.COLUMN_TYPES[i],"int"===u?r[c][d]=parseInt(o[i],10):"double"===u||"float"===u||"long"===u?r[c][d]=parseFloat(o[i]):"boolean"===u?"true"===o[i]?r[c][d]=!0:"false"===o[i]&&(r[c][d]=!1):r[c][d]=o[i];return g={metadata:f,data:r}}function i(){var e,t,s;e=n.svg.arc().innerRadius(50).outerRadius(51).startAngle(0).endAngle(360*(Math.PI/180)),t=n.svg.arc().innerRadius(150).outerRadius(151).startAngle(0).endAngle(360*(Math.PI/180)),s=n.svg.arc().innerRadius(250).outerRadius(251).startAngle(0).endAngle(360*(Math.PI/180)),l.append("g").attr("id","arcs"),l.select("#arcs").append("path").attr("d",e).attr("transform","translate("+h(0)+","+(f-x(0))+")").attr("class","arc"),l.select("#arcs").append("path").attr("d",t).attr("transform","translate("+h(0)+","+(f-x(0))+")").attr("class","arc"),l.select("#arcs").append("path").attr("d",s).attr("transform","translate("+h(0)+","+(f-x(0))+")").attr("class","arc")}function d(e,s){var r,i,d=8,u=10,g=10,p=e.length;for(r=0;p>r;r+=1)e[r].MemberGenes=s[e[r]["Gene.Set.Name"]];i={Phenotype:s["Target Class"]},i.direction=s.Direction,i=[i],l.append("polygon").attr("points",function(){return o.interpolateCross(d)}).attr("class","phen").data(i),l.select("polygon").on("mouseover",function(e){var s=parseInt(t("svg.canvas").css("margin-left"),10),l=document.getElementById("svgContainer").getBoundingClientRect().top,a=h(0)+g+s,r=f-x(0)+g+l;n.select("#phenTooltip").style("left",a+"px").style("top",r+"px").select("#phenotype").text(e.Phenotype),n.select("#phenTooltip").select("#direction").text(e.direction),n.select("#phenTooltip").classed("hidden",!1)}).on("mouseout",function(){n.select("#phenTooltip").select("svg").remove(),n.select("#phenTooltip").classed("hidden",!0)}),l.selectAll("circle").data(e).enter().append("circle").attr("cx",function(e){return h(e.x)}).attr("cy",function(e){return f-x(e.y)}).attr("r",d).attr("class","geneset").on("mouseover",function(e){var s=parseInt(t("svg.canvas").css("margin-left"),10),l=document.getElementById("svgContainer").getBoundingClientRect().top,a=parseFloat(n.select(this).attr("cx"))+g+s,r=parseFloat(n.select(this).attr("cy"))+g+l;n.select(this).attr("r",u),n.select("#tooltip").style("left",a+"px").style("top",r+"px").select("#name").text(e["Gene.Set.Name"]),n.select("#tooltip").select("#size").text(e["gene.set.size"]),n.select("#tooltip").select("#url").text("Placeholder"),n.select("#tooltip").classed("hidden",!1)}).on("mouseout",function(){n.select(this).attr("r",d),n.select("#tooltip").select("svg").remove(),n.select("#tooltip").classed("hidden",!0)}).on("click",function(){var e;n.selectAll(".brush").call(a.clear()),l.select("#edgeGroup").selectAll("path").classed("selectedEdge",!1),n.event.shiftKey?(e=n.select(this),e.classed("selectedNode",!0),c.display()):(l.selectAll("circle").classed("selectedNode",!1),e=n.select(this),e.classed("selectedNode",!0),c.display())})}function u(e){var t=e.split("\n"),n=s(t);d(n.data,n.metadata)}function g(e,s){var d,u,g,v,y,m,b,M="#778BAD",A=(l.select("#backgroundRect").style("fill"),8),T=3;for(d=parseFloat(s["Max Abs Extent"]),o.setScales(d),i(),u=n.min(e,function(e){return e.Jaccard}),g=n.max(e,function(e){return e.Jaccard}),v=0;v<e.length;v+=1)y=s["Gene Set Names"],m=y[e[v].Index1-1],b=y[e[v].Index2-1],e[v].gs1=m,e[v].gs2=b,e[v].gs1Members=s[m],e[v].gs2Members=s[b],e[v].gsIntersect=r.intersect(e[v].gs1Members.sort(),e[v].gs2Members.sort()),e[v].gsUnion=r.union(e[v].gs1Members.sort(),e[v].gs2Members.sort()),e[v].gs1Unique=r.unique(e[v].gs1Members,e[v].gs2Members),e[v].gs2Unique=r.unique(e[v].gs2Members,e[v].gs1Members);l.append("g").attr("id","edgeGroup"),l.select("#edgeGroup").selectAll("path").data(e).enter().append("path").attr("d",function(e){var t=o.jaccard2Width(e.Jaccard,g,u),n={x:h(e.x1),y:f-x(e.y1)},s={x:h(e.x2),y:f-x(e.y2)},l=Math.atan(t/Math.sqrt(A*A-t*t));return o.calcEdgePath(n,s,A,l,t/T)}).attr("fill",M).on("mouseover",function(e){var s,l,a=parseInt(t("svg.canvas").css("margin-left"),10)+p,r=document.getElementById("svgContainer").getBoundingClientRect().top,c=n.select("#genelists");for(n.select(this).classed("selectedEdge",!0),c.style("left",a+"px").style("top",r+"px").select("#name1").text(e.gs1),c.select("#name2").text(e.gs2),c.select("#edgeGenes").selectAll("li").remove(),l=e.gsIntersect.length<15?e.gsIntersect.length:15,s=0;l>s;s+=1)c.select("#edgeGenes").append("li").text(e.gsIntersect[s]);c.select("#edgeGenes").append("li").text("..."),n.select("#genelists").classed("hidden",!1)}).on("mouseout",function(){n.select(this).classed("selectedEdge",!1),n.select("#genelists").classed("hidden",!0)}).on("click",function(e){var t,s,r;n.selectAll(".brush").call(a.clear()),l.select("#edgeGroup").selectAll("path").classed("selectedEdge",!1),l.selectAll("circle").classed("selectedNode",!1),t=n.select(this),t.classed("selectedEdge",!0),s=e,r=l.selectAll(".geneset"),r.classed("selectedNode",function(e){return e["Gene.Set.Name"]===s.gs1||e["Gene.Set.Name"]===s.gs2}),c.display()})}function v(e){var t=e.split("\n"),n=s(t);g(n.data,n.metadata)}var y={};return y.main=function(){var e="ConstellationMap.plot.data.nodes.odf",n="ConstellationMap.plot.data.edges.odf";t.ajax({url:n,type:"GET",dataType:"text",success:function(e,t){console.log(t+": successfully loaded file "+n),v(e)},error:function(e,t){alert(t+": failed to load file "+n)}}),t.ajax({url:e,type:"GET",dataType:"text",success:function(t,n){console.log(n+": successfully loaded file "+e),u(t)},error:function(t,n){alert(n+": failed to load file "+e)}})},y}(e,jQuery),g=function(e,t){function s(){t(".text-tooltip").tooltip()}function r(){n.select("#exportSvg").on("click",function(){var t;t=n.select("svg").attr("title","ConstellationMapImage").attr("version",1.1).attr("xmlns","http://www.w3.org/2000/svg").node().parentNode.innerHTML,n.select("#modalSvgBody").selectAll("img").remove(),n.select("#modalSvgBody").append("img").attr("src","data:image/svg+xml;base64,"+e.btoa(t)).attr("class","img-rounded img-responsive"),n.select("#modalSvgFooter").select("a").remove(),n.select("#modalSvgFooter").append("a").attr("href-lang","image/svg+xml").attr("href","data:image/svg+xml;base64,"+e.btoa(t)).attr("download","download.svg"),n.select("#modalSvgFooter").select("a").append("button").attr("type","button").attr("class","btn btn-primary").text("Save")})}var o={};return o.main=function(){a=n.svg.brush().x(n.scale.identity().domain([0,p])).y(n.scale.identity().domain([0,f])).on("brush",d.move).on("brushend",d.stop),l=n.select("svg").attr("class","canvas").style("align","center").attr("width",p).attr("height",f),l.append("rect").attr("id","backgroundRect").attr("x",0).attr("y",0).attr("width",p).attr("height",f),l.append("g").attr("class","brush").call(a).call(a.event),u.main(),s(),r(),c.fuzzFactorListen()},o}(e,jQuery),{init:g.main}}(window,jQuery,d3);$(document).ready(function(){"use strict";globalWrapper.init()});